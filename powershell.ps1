if ( $PsVersionTable.PSVersion.Major -lt 3 ) { Write-Host "Windows PowerShell Version 3.0 or later needs to be installed in order to execute Content Matrix PowerShell scripts."; exit; }
if ( (Get-PSSnapin -Name Metalogix.System.Commands -ErrorAction SilentlyContinue) -eq $null ) { add-pssnapin Metalogix.System.Commands | out-null }
if ( (Get-PSSnapin -Name Metalogix.SharePoint.Migration.Commands -ErrorAction SilentlyContinue) -eq $null ) { add-pssnapin Metalogix.SharePoint.Migration.Commands | out-null }

if (Get-Command Set-MetalogixJobPrerequisites -ErrorAction SilentlyContinue){ Set-MetalogixJobPrerequisites -Value "Content Matrix Console - SharePoint Edition" }

# Set default resolvers
Set-MetalogixDefaultResolverSetting -Name "NodeLocation" -Value "Metalogix.Explorer.PersistentConnectionsResolver, Metalogix.Explorer, Version=9.2.0.4, Culture=neutral, PublicKeyToken=3b240fac3e39fc03"
Set-MetalogixDefaultResolverSetting -Name "ResourceTableResourceTableLink" -Value "Metalogix.ResourceFileTableResolver, Metalogix.Core, Version=9.2.0.4, Culture=neutral, PublicKeyToken=3b240fac3e39fc03"
Set-MetalogixDefaultResolverSetting -Name "DataResolverDataRepositoryLink" -Value "Metalogix.Client.ClientDataRepositoryResolver, Metalogix.Client, Version=9.2.0.4, Culture=neutral, PublicKeyToken=3b240fac3e39fc03"

# Load configuration settings
Load-MetalogixConfigurationVariableSettings -FilePath "C:\Users\sp10_farm\AppData\Roaming\Metalogix\UserSettings.xml" -Scope UserSpecific
Load-MetalogixConfigurationVariableSettings -FilePath "C:\Users\sp10_farm\AppData\Roaming\Metalogix\Content Matrix Console - SharePoint Edition\ApplicationSettings.xml" -Scope ApplicationAndUserSpecific
Load-MetalogixConfigurationVariableSettings -FilePath "C:\ProgramData\Metalogix\EnvironmentSettings.xml" -Scope EnvironmentSpecific

$quote = "`""
$sourceSite = "https://usfema.sharepoint.com/teams/Template-DR"
$sourceWeb =  "/APO" 
$sourceList = "/SitePages"

$targetSite = "https://usfema.sharepoint.com/teams/DR4617-NC"

$srcOne = $quote + $sourceWeb + $sourceList + $quote
$srcTwo  = $quote + $sourceSite + $sourceWeb + $sourceList + $quote
$srcThree  = $quote + $sourceSite + $quote

$srcFour = $quote + $sourceWeb + $quote
$srcFive = $quote + $targetSite + $sourceWeb + $quote
$srcSix = $quote + $targetSite + $quote


# Load source
$SourceCollection = New-MetalogixSerializableObjectCollection "<IXMLAbleList IXMLAbleType=`"Metalogix.Explorer.NodeCollection, Metalogix.Explorer, Version=9.2.0.4, Culture=neutral, PublicKeyToken=3b240fac3e39fc03`"><NodeCollection><Location Path=" + $srcOne + " DisplayUrl=" + $srcTwo + " ><Connection NodeType=`"Metalogix.SharePoint.SPWeb, Metalogix.SharePoint, Version=9.2.0.4, Culture=neutral, PublicKeyToken=3b240fac3e39fc03`" SharePointVersion=`"2147483647.0.0.0`" UnderlyingAdapterType=`"CSOM`" ShowAllSites=`"True`" AdapterType=`"CSOM`" Url="+ $srcThree + " UserName=`"fema-spomigration@usfema.onmicrosoft.com`" SavePassword=`"True`" Password=`"AQAAANCMnd8BFdERjHoAwE/Cl+sBAAAAZUFlUjBpMU6F0WNyGmncfQAAAAACAAAAAAADZgAAwAAAABAAAACwvy2rp6XsOD+Y5OikBRiNAAAAAASAAACgAAAAEAAAAISgMm3RScKrOrIFQYmrUgcYAAAAeorurLbBr26gD8JX0ombG3C0KZKskX/3FAAAAIsMWUNuHKM1Vs+IBAAsMrcoAbaN`" ReadOnly=`"False`" AuthenticationType=`"Metalogix.SharePoint.Adapters.CSOM2013.Authentication.Office365StandADFSInitializer`" IsOAuthAuthentication=`"False`" /></Location></NodeCollection></IXMLAbleList>"

# Load target
$TargetCollection = New-MetalogixSerializableObjectCollection "<IXMLAbleList IXMLAbleType=`"Metalogix.Explorer.NodeCollection, Metalogix.Explorer, Version=9.2.0.4, Culture=neutral, PublicKeyToken=3b240fac3e39fc03`"><NodeCollection><Location Path=" + $srcFour + " DisplayUrl=" + srcFive + "><Connection NodeType=`"Metalogix.SharePoint.SPWeb, Metalogix.SharePoint, Version=9.2.0.4, Culture=neutral, PublicKeyToken=3b240fac3e39fc03`" SharePointVersion=`"2147483647.0.0.0`" UnderlyingAdapterType=`"CSOM`" ShowAllSites=`"True`" AdapterType=`"CSOM`" Url=" + srcSix + " UserName=`"fema-spomigration@usfema.onmicrosoft.com`" SavePassword=`"True`" Password=`"AQAAANCMnd8BFdERjHoAwE/Cl+sBAAAAZUFlUjBpMU6F0WNyGmncfQAAAAACAAAAAAADZgAAwAAAABAAAADM81ZMyMnQGFYtPN6Yq1XZAAAAAASAAACgAAAAEAAAADjKssFFSSFgo6usJ1SLv4YYAAAAdpVvoVHktgs4g0ES6XOB/xba/zqliS2YFAAAAIH0Zgy/oWW9CIshnDdvllxzoEzv`" ReadOnly=`"False`" AuthenticationType=`"Metalogix.SharePoint.Adapters.CSOM2013.Authentication.Office365StandADFSInitializer`" IsOAuthAuthentication=`"False`" /></Location></NodeCollection></IXMLAbleList>"

# Run the action
foreach($Target in $TargetCollection) {
    $SourceCollection | Copy-MLSharePointList -Target $Target  -CopyListPermissions -OverwriteLists -CheckModifiedDatesForLists -CopyFolderPermissions -CopyListItems -UseAzureOffice365Upload -EncryptAzureMigrationJobs -IsAzurePrivateContainer "False" -CopyDocumentWebParts -CopyContentZoneContent -ExistingWebPartsAction "Delete" -CopyRootPermissions -MapRolesByName -ClearRoleAssignments -CopyItemPermissions -OverwriteItems -CheckModifiedDatesForItemsDocuments -CopyVersions -CopySubFolders -PreserveItemIDs -MigrationMode "Full" -ForceRefresh -CorrectingLinks -LinkCorrectionScope "SiteCollection" -MapGroupsByName -OverwriteGroups -MapMissingUsersToLoginName "femaspomigration@usfema.onmicrosoft.com" -OverrideCheckouts -Transformers ( New-MetalogixSerializableObject "Metalogix.Transformers.TransformerCollection" "Metalogix.Actions" "<TransformerCollection><Transformer TransformerType=`"Metalogix.SharePoint.Actions.Transform.ContentTypeFieldMapper, Metalogix.SharePoint.Actions, Version=9.2.0.4, Culture=neutral, PublicKeyToken=3b240fac3e39fc03`" ReadOnly=`"True`" /><Transformer TransformerType=`"Metalogix.SharePoint.Actions.Transform.DocumentSetsFolderApplicator, Metalogix.SharePoint.Actions, Version=9.2.0.4, Culture=neutral, PublicKeyToken=3b240fac3e39fc03`" ReadOnly=`"True`" /><Transformer TransformerType=`"Metalogix.SharePoint.Actions.Transform.ReferencedFolderDataUpdater, Metalogix.SharePoint.Actions, Version=9.2.0.4, Culture=neutral, PublicKeyToken=3b240fac3e39fc03`" ReadOnly=`"True`" /><Transformer TransformerType=`"Metalogix.SharePoint.Actions.Transform.FolderColumnMapper, Metalogix.SharePoint.Actions, Version=9.2.0.4, Culture=neutral, PublicKeyToken=3b240fac3e39fc03`" ReadOnly=`"True`" /><Transformer TransformerType=`"Metalogix.SharePoint.Actions.Transform.ManagedMetadataItemValueMapper, Metalogix.SharePoint.Actions, Version=9.2.0.4, Culture=neutral, PublicKeyToken=3b240fac3e39fc03`" ReadOnly=`"True`" /><Transformer TransformerType=`"Metalogix.SharePoint.Actions.Transform.DeletionPropagator, Metalogix.SharePoint.Actions, Version=9.2.0.4, Culture=neutral, PublicKeyToken=3b240fac3e39fc03`" ReadOnly=`"True`" /><Transformer TransformerType=`"Metalogix.SharePoint.Actions.Transform.ReferencedListItemDataUpdater, Metalogix.SharePoint.Actions, Version=9.2.0.4, Culture=neutral, PublicKeyToken=3b240fac3e39fc03`" ReadOnly=`"True`" /><Transformer TransformerType=`"Metalogix.SharePoint.Actions.Transform.DocumentSetsApplicator, Metalogix.SharePoint.Actions, Version=9.2.0.4, Culture=neutral, PublicKeyToken=3b240fac3e39fc03`" ReadOnly=`"True`" /><Transformer TransformerType=`"Metalogix.SharePoint.Actions.Transform.ContentTypesApplicator, Metalogix.SharePoint.Actions, Version=9.2.0.4, Culture=neutral, PublicKeyToken=3b240fac3e39fc03`" ReadOnly=`"True`" /><Transformer TransformerType=`"Metalogix.SharePoint.Actions.Transform.ListItemColumnMapper, Metalogix.SharePoint.Actions, Version=9.2.0.4, Culture=neutral, PublicKeyToken=3b240fac3e39fc03`" ReadOnly=`"True`" /><Transformer TransformerType=`"Metalogix.SharePoint.Actions.Transform.WorkflowDataUpdater, Metalogix.SharePoint.Actions, Version=9.2.0.4, Culture=neutral, PublicKeyToken=3b240fac3e39fc03`" ReadOnly=`"True`" /><Transformer TransformerType=`"Metalogix.SharePoint.Actions.Transform.PublishingDataUpdater, Metalogix.SharePoint.Actions, Version=9.2.0.4, Culture=neutral, PublicKeyToken=3b240fac3e39fc03`" ReadOnly=`"True`" /><Transformer TransformerType=`"Metalogix.SharePoint.Actions.Transform.InfopathItemContentXml, Metalogix.SharePoint.Actions, Version=9.2.0.4, Culture=neutral, PublicKeyToken=3b240fac3e39fc03`" ReadOnly=`"True`" /><Transformer TransformerType=`"Metalogix.SharePoint.Actions.Transform.ListColumnMapper, Metalogix.SharePoint.Actions, Version=9.2.0.4, Culture=neutral, PublicKeyToken=3b240fac3e39fc03`" ReadOnly=`"True`" /><Transformer TransformerType=`"Metalogix.SharePoint.Actions.Transform.BDCUpdater, Metalogix.SharePoint.Actions, Version=9.2.0.4, Culture=neutral, PublicKeyToken=3b240fac3e39fc03`" ReadOnly=`"True`" /><Transformer TransformerType=`"Metalogix.SharePoint.Actions.Transform.ListGuidMapper, Metalogix.SharePoint.Actions, Version=9.2.0.4, Culture=neutral, PublicKeyToken=3b240fac3e39fc03`" ReadOnly=`"True`" /><Transformer TransformerType=`"Metalogix.SharePoint.Actions.Transform.MapUsers, Metalogix.SharePoint.Actions, Version=9.2.0.4, Culture=neutral, PublicKeyToken=3b240fac3e39fc03`" ReadOnly=`"True`" /><Transformer TransformerType=`"Metalogix.SharePoint.Actions.Transform.WebPartsProcessor, Metalogix.SharePoint.Actions, Version=9.2.0.4, Culture=neutral, PublicKeyToken=3b240fac3e39fc03`" ReadOnly=`"True`" /></TransformerCollection>" -Enumerate) -jobfile "C:\Users\sp10_farm\AppData\Roaming\Metalogix\Content Matrix Console - SharePoint Edition\JobHistory.lst" -jobtitle "Paste List"
}
